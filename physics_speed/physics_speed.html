<html>
  <head>
    <script>
      let busElt;
      let distanceGraphElt;
      let speedGraphElt;
      let accGraphElt;
      let containerWidth;
      let busWidth;
      let start;
      let durationLastX = 0;
      let durationLastY = 0;
      let speedLastX = 0;
      let speedLastY = 0;
      let accLastX = 0;
      let accLastY = 0;

      const sectionsStr = new URLSearchParams(window.location.search).get('p').split("|");
      let sections = sectionsStr.map(function(s) {
        const params = s.split(";")
        const duration = Number(params[0]);
        const speed = Number(params[1]);
        const acceleration = Number(params[2]);

        const distance = speed*duration + acceleration*duration*duration;

        return {distance, speed, acceleration, duration};
      });
      const totalDuration = sections.reduce((soFar, cur) => soFar + cur.duration, 0);
      const maxSpeed = Math.ceil(Math.max(...sections.map(({speed, duration, acceleration}) => acceleration > 0
        ? speed+acceleration*duration
        : speed)));
      const maxAcc = Math.ceil(Math.max(...sections.map(({acceleration}) => acceleration)));

      function getCurSectionInfo(elapsedSecs) {
        let remainingSecs = elapsedSecs;
        const passedSections = [];
        for (let section of sections) {
          if (remainingSecs >= section.duration) {
            passedSections.push(section);
            remainingSecs -= section.duration;
          } else {
            return {passedSections, section, remainingSecs};
          }
        }
      }

      function step(timestamp) {
        if (start === undefined) {
          start = timestamp;
        }
        const elapsedSecs = (timestamp - start) / 1000;

        const {passedSections, section, remainingSecs} = getCurSectionInfo(elapsedSecs);

        const percentDistance = passedSections.reduce((soFar, cur) => soFar+cur.distance, 0) +
          section.speed * remainingSecs + section.acceleration * remainingSecs * remainingSecs;

        const shift = Math.max(0, Math.min(percentDistance / 100 * containerWidth, containerWidth) - busWidth);
        busElt.style.transform = `translateX(${shift}px)`;

        const distanceCtx = distanceGraphElt.getContext("2d");
        distanceCtx.save();
        distanceCtx.strokeStyle = "blue";
        distanceCtx.lineCap = "round";
        distanceCtx.lineWidth = 4;
        distanceCtx.translate(50, 250); // origin bottom-left
        distanceCtx.beginPath();
        distanceCtx.moveTo(durationLastX, durationLastY);
        const distanceNewX = elapsedSecs*200/totalDuration;
        const distanceNewY = -percentDistance*200/100;
        distanceCtx.lineTo(distanceNewX, distanceNewY);
        distanceCtx.stroke();
        // reset the translate
        distanceCtx.restore();
        durationLastX = distanceNewX;
        durationLastY = distanceNewY;

        const speedCtx = speedGraphElt.getContext("2d");
        speedCtx.save();
        speedCtx.strokeStyle = "blue";
        speedCtx.lineCap = "round";
        speedCtx.lineWidth = 4;
        speedCtx.translate(50, 250); // origin bottom-left
        speedCtx.beginPath();
        speedCtx.moveTo(speedLastX, speedLastY);
        const speedNewX = elapsedSecs*200/totalDuration;
        const speedNewY = -(section.speed + section.acceleration * remainingSecs)*200/maxSpeed;
        speedCtx.lineTo(speedNewX, speedNewY);
        speedCtx.stroke();
        speedCtx.restore();
        speedLastX = speedNewX;
        speedLastY = speedNewY;

        const accCtx = accGraphElt.getContext("2d");
        accCtx.save();
        accCtx.strokeStyle = "blue";
        accCtx.lineCap = "round";
        accCtx.lineWidth = 4;
        accCtx.translate(50, 250); // origin bottom-left
        accCtx.beginPath();
        accCtx.moveTo(accLastX, accLastY);
        const accNewX = elapsedSecs*200/totalDuration;
        const accNewY = -section.acceleration*200/maxAcc;
        accCtx.lineTo(accNewX, accNewY);
        accCtx.stroke();
        accCtx.restore();
        accLastX = accNewX;
        accLastY = accNewY;

        if (shift < containerWidth - busWidth) {
          requestAnimationFrame(step);
        } else {
          durationLastX = 0;
          durationLastY = 0;
          speedLastX = 0;
          speedLastY = 0;
          accLastX = 0;
          accLastY = 0;
        }
      }

      function drawAxes(canvasElt, yLabel) {
        const ctx = canvasElt.getContext("2d");
        ctx.clearRect(0, 0, canvasElt.width, canvasElt.height);

        ctx.translate(50, 250); // origin bottom-left

        // axes
        ctx.beginPath();
        ctx.moveTo(0, 0); ctx.lineTo(200, 0); // X axis
        ctx.moveTo(0, 0); ctx.lineTo(0, -200); // Y axis
        ctx.stroke();

        // draw X axis ticks every second
        const secondDuration = 200/totalDuration;
        for (let x = 1; x <= totalDuration; x += 1) {
          ctx.beginPath();
          ctx.moveTo(secondDuration*x, -5);
          ctx.lineTo(secondDuration*x, 5);
          ctx.stroke();
        }

        // draw Y axis ticks every 50px
        for (let y = -50; y >= -200; y -= 50) {
          ctx.beginPath();
          ctx.moveTo(-5, y);
          ctx.lineTo(5, y);
          ctx.stroke();
        }

        // labels
        ctx.fillText("ÄŒas: " + totalDuration, 200, 15);
        ctx.fillText(yLabel, -15, -200);

        // reset the translate
        ctx.setTransform(1, 0, 0, 1, 0, 0);
      }

      function doAnimate() {
        travelDescElt = document.getElementById("travelDesc");
        let desc = "";
        for (const {distance, speed, acceleration, duration} of sections) {
          desc += "<br>Trajanje: " + duration + " Razdalja: " + distance + " Hitrost: " + speed + " PospeÅ¡ek: " + acceleration;
        }
        travelDescElt.innerHTML = desc;

        busElt = document.getElementById("bus");

        distanceGraphElt = document.getElementById("distance");
        drawAxes(distanceGraphElt, "Razdalja %");

        speedGraphElt = document.getElementById("speed");
        drawAxes(speedGraphElt, "Hitrost: " + maxSpeed);

        accGraphElt = document.getElementById("acceleration");
        drawAxes(accGraphElt, "PospeÅ¡ek: " + maxAcc);

        const parent = busElt.parentElement;
        const style = window.getComputedStyle(parent);
        containerWidth = busElt.parentElement.offsetWidth - parseFloat(style.paddingLeft) - parseFloat(style.paddingRight);
        busWidth = busElt.offsetWidth;
        start = undefined;
        requestAnimationFrame(step);
      }
    </script>
  </head>
  <body>
    <button onClick="doAnimate()">Animiraj</button>
    <div style="padding: 20px; max-width: 100%; border: solid black 1px">
      <span id="bus" style="font-size: 70px; display: inline-block">
        ðŸšŒ
      </span>
    </div>
    <canvas id="distance" width="300" height="300"></canvas>
    <canvas id="speed" width="300" height="300"></canvas>
    <canvas id="acceleration" width="300" height="300"></canvas>
    <span id="travelDesc"></span>
  </body>
</html>
